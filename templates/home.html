{% extends "base.html" %}
{% block content %}

<h1 class="page-title">Mobile Store</h1>

<form class="filters" method="GET" action="/">
  
  <input type="hidden" name="q" value="{{ q }}">

  <select name="brand">
    <option value="">All Brands</option>
    {% for b in brands %}
      <option value="{{ b }}" {% if brand==b %}selected{% endif %}>{{ b }}</option>
    {% endfor %}
  </select>

  <select name="category">
    <option value="">All Categories</option>
    {% for c in categories %}
      <option value="{{ c }}" {% if category==c %}selected{% endif %}>{{ c }}</option>
    {% endfor %}
  </select>

  <select name="sort">
    <option value="">Default</option>
    <option value="price_asc" {% if sort=="price_asc" %}selected{% endif %}>Price Low ‚Üí High</option>
    <option value="price_desc" {% if sort=="price_desc" %}selected{% endif %}>Price High ‚Üí Low</option>
  </select>

  <button class="btn tiny">Apply</button>
</form>


<div class="grid">
  {% for p in products %}
  <div class="card">

    <a href="/product/{{ p.id }}">
      <img class="thumb" src="/static/img/{{ p.image }}" alt="{{ p.name }}">
    </a>

    <div class="card-body">
      <div class="row">
        <div>
          <div class="name">{{ p.name }}</div>
          <div class="muted">{{ p.brand }}</div>
        </div>
        <div class="price">Rs {{ p.price }}</div>
      </div>

      <div class="actions">

        <!-- ADD TO CART -->
        <button class="btn" onclick="addToCart({{p.id}})">
          Add to Cart
        </button>

        <!-- WISHLIST HEART -->
        <button class="btn outline heart"
                onclick="toggleWish({{p.id}}, this)">
            {% if p.id in wishlist %}
                ‚ù§Ô∏è
            {% else %}
                ü§ç
            {% endif %}
        </button>

        <!-- BUY NOW -->
        <a class="btn outline" href="/buy-now/{{p.id}}">
          Buy Now
        </a>

      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% endblock %}


{% block scripts %}
<script>

async function addToCart(pid){
  const res = await fetch("/api/cart/add", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({product_id: pid, qty:1})
  });

  if(res.status === 401){
    window.location.href = "/login";
    return;
  }

  alert("Added to cart");
  location.reload();
}


async function toggleWish(pid, btn){
  const res = await fetch("/toggle_wishlist/" + pid);
  const data = await res.json();

  if(data.status === "added"){
      btn.innerHTML = "‚ù§Ô∏è";
  }else{
      btn.innerHTML = "ü§ç";
  }
}

</script>
{% endblock %}
